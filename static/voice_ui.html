<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice UI Control</title>
    <style>
        body {
            font-family: sans-serif;
            transition: all 0.5s;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            transition: all 0.5s;
        }

        h1 {
            transition: all 0.5s;
        }

        .box {
            width: 100px;
            height: 100px;
            background-color: #ddd;
            margin: 20px 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.5s;
        }

        .controls {
            margin-bottom: 20px;
        }

        button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
        }

        button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        #recordingStatus {
            color: red;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container" id="mainContainer">
        <h1 id="mainTitle">ç”¨å£°éŸ³æ§åˆ¶ UI</h1>

        <div class="controls">
            <p>1. å½•éŸ³æ§åˆ¶:</p>
            <button id="startBtn" onclick="startRecording()">å¼€å§‹å½•éŸ³</button>
            <button id="stopBtn" onclick="stopRecording()" disabled>åœæ­¢å½•éŸ³</button>
            <span id="recordingStatus"></span>

            <p>2. æˆ–è€…ä¸Šä¼ å½•éŸ³æ–‡ä»¶:</p>
            <input type="file" id="fileInput" accept="audio/*">
            <button onclick="uploadFile()">ä¸Šä¼ æ–‡ä»¶</button>
        </div>

        <div id="statusArea"></div>

        <div class="box" id="demoBox">Demo Box</div>
    </div>

    <script>
        let pollInterval;
        let mediaRecorder;
        let audioChunks = [];

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    // åˆ›å»ºä¸€ä¸ª File å¯¹è±¡ï¼Œæ¨¡æ‹Ÿæ–‡ä»¶ä¸Šä¼ 
                    const file = new File([audioBlob], "recording.webm", { type: "audio/webm" });
                    uploadAudioFile(file);
                };

                mediaRecorder.start();
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingStatus').innerText = "ğŸ”´ æ­£åœ¨å½•éŸ³...";
            } catch (err) {
                console.error("Error accessing microphone:", err);
                alert("æ— æ³•è®¿é—®éº¦å…‹é£: " + err.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('recordingStatus').innerText = "";
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
                return;
            }
            uploadAudioFile(file);
        }

        async function uploadAudioFile(file) {
            const formData = new FormData();
            formData.append("file", file);

            document.getElementById('statusArea').innerText = "æ­£åœ¨ä¸Šä¼ ...";

            try {
                const response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.task_id) {
                    document.getElementById('statusArea').innerText = "ä»»åŠ¡ ID: " + data.task_id + " (å¤„ç†ä¸­...)";
                    startPolling(data.task_id);
                } else {
                    alert("ä¸Šä¼ å¤±è´¥: " + JSON.stringify(data));
                }
            } catch (error) {
                console.error(error);
                alert("ä¸Šä¼ å‡ºé”™");
            }
        }

        function startPolling(taskId) {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/task/${taskId}`);
                    const data = await response.json();

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        document.getElementById('statusArea').innerText = "å®Œæˆ! ç»“æœ: " + data.result;

                        // å°è¯•è§£æ JSON å¹¶æ‰§è¡Œ UI å˜æ›´
                        try {
                            let command = JSON.parse(data.result);
                            applyUICommand(command);
                        } catch (e) {
                            console.log("ç»“æœä¸æ˜¯ JSONï¼Œå¯èƒ½æ˜¯æ™®é€šè½¬å½•æ–‡æœ¬", data.result);
                        }
                    } else if (data.status === 'failed') {
                        clearInterval(pollInterval);
                        document.getElementById('statusArea').innerText = "å¤±è´¥: " + data.result;
                    }
                } catch (error) {
                    console.error(error);
                }
            }, 1000);
        }

        function applyUICommand(cmd) {
            console.log("Applying command:", cmd);

            if (cmd.action === 'unknown') {
                console.log("Unknown action, ignoring.");
                return;
            }

            let targetElement;

            if (cmd.target.includes('background') || cmd.target.includes('èƒŒæ™¯')) {
                targetElement = document.body;
            } else if (cmd.target.includes('title') || cmd.target.includes('æ ‡é¢˜')) {
                targetElement = document.getElementById('mainTitle');
            } else if (cmd.target.includes('box') || cmd.target.includes('ç›’å­')) {
                targetElement = document.getElementById('demoBox');
            } else if (cmd.target.includes('container')) {
                targetElement = document.getElementById('mainContainer');
            }

            if (!targetElement) {
                console.warn("Unknown target:", cmd.target);
                return;
            }

            if (cmd.action === 'change_color') {
                targetElement.style.backgroundColor = cmd.value;
                targetElement.style.color = isDark(cmd.value) ? 'white' : 'black';
            } else if (cmd.action === 'change_text') {
                targetElement.innerText = cmd.value;
            } else if (cmd.action === 'change_size') {
                // targetElement.style.fontSize = cmd.value;
                console.log(`target element is ${targetElement}`);
                targetElement.style.width = `${cmd.value}px`;
                targetElement.style.height = `${cmd.value}px`;
            }
        }

        function isDark(color) {
            return ['black', 'blue', 'red', 'purple', 'green'].includes(color.toLowerCase());
        }
    </script>
</body>

</html>